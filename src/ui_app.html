<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>App de Conferencia - UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <style>
    .badge{border-radius:9999px;padding:.125rem .5rem;font-size:.75rem;font-weight:600;display:inline-block}
    .cell-mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .row-ok{background:#d1fae5}
    .row-alerta{background:#fef3c7}
    .row-div{background:#fee2e2}
    .row-neutro{background:#e5e7eb}
    .outline-auto{outline:2px solid #2563eb}
    .shadow-soft{box-shadow:0 1px 2px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.04)}
    .table-sticky thead th{position:sticky;top:0;background:#0f172a;color:#fff;z-index:1}
    .table-sticky thead th{font-weight:600}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div id="root"></div>

<script type="text/javascript">
const {useState,useEffect,useMemo,useCallback,useRef,useContext,Fragment} = React;

const DEFAULT_API_BASE = (() => {
  if (typeof window !== "undefined") {
    if (typeof window.UI_API_BASE !== "undefined") {
      const configured = String(window.UI_API_BASE);
      return configured.replace(/\/$/, "");
    }
    try {
      const params = new URLSearchParams(window.location.search);
      const param = params.get("api");
      if (param) {
        return param.replace(/\/$/, "");
      }
    } catch (err) {
      console.warn("Falha ao ler parametro ?api:", err);
    }
  }
  return "http://localhost:8000";
})();
// Ajuste `window.UI_API_BASE` ou adicione ?api=http://host:porta na URL antes de carregar o arquivo
// para definir outro endpoint.

const STATUS_COLORS = {
  "OK": {bg:"#d1fae5", badge:"#16a34a", text:"#052e16"},
  "ALERTA": {bg:"#fef3c7", badge:"#f59e0b", text:"#451a03"},
  "DIVERGENCIA": {bg:"#fee2e2", badge:"#dc2626", text:"#450a0a"},
  "SEM_FONTE": {bg:"#e5e7eb", badge:"#6b7280", text:"#111827"},
  "SEM_SUCESSOR": {bg:"#e5e7eb", badge:"#6b7280", text:"#111827"},
};

const STATUS_KEY = {
  OK: 'ok',
  ALERTA: 'alerta',
  DIVERGENCIA: 'divergencia',
  SEM_FONTE: 'sem_fonte',
  SEM_SUCESSOR: 'sem_sucessor'
};

const FILTER_DEFAULTS = Object.freeze({status:"", fonte_tipo:"", cfop:"", q:""});

function createDefaultFilters(){
  return {...FILTER_DEFAULTS};
}

const REQUIRED_UPLOADS = [
  {type: "sucessor", label: "Sucessor (contábil)", hint: "Ex: sucessor.csv"},
  {type: "entradas", label: "Suprema Entradas", hint: "Ex: suprema_entradas.csv"},
  {type: "saidas", label: "Suprema Saídas", hint: "Ex: suprema_saidas.csv"},
  {type: "servicos", label: "Suprema Serviços", hint: "Ex: suprema_servicos.csv"},
  {type: "fornecedores", label: "Fornecedores", hint: "Ex: fornecedores.csv"},
  {type: "plano", label: "Plano de Contas", hint: "Ex: plano_contas.csv"}
];

const JOB_ACTIVE_STATES = new Set(["queued","running","pending","processing","in_progress","cancelling"]);

const DEFAULT_COLUMNS = [
  {id:"strategy",label:"Regra",type:"text"},
  {id:"score",label:"Score",type:"number"},
  {id:"S.data",label:"Data (S)",type:"date"},
  {id:"S.debito",label:"Debito",type:"text"},
  {id:"S.credito",label:"Credito",type:"text"},
  {id:"S.doc",label:"No Docto (S)",type:"text"},
  {id:"S.valor",label:"Valor (S)",type:"money"},
  {id:"F.doc",label:"No Docto (F)",type:"text"},
  {id:"F.valor",label:"Valor (F)",type:"money"},
  {id:"F.cfop",label:"CFOP",type:"text"},
  {id:"delta.valor",label:"Delta Valor",type:"money"},
  {id:"delta.dias",label:"Delta Dias",type:"number"},
  {id:"motivos",label:"Motivos",type:"text"}
];

const ToastContext = React.createContext(null);

const TOAST_TONES = {
  success: {border:"border-emerald-500/40", indicator:"bg-emerald-500", title:"text-emerald-900", description:"text-emerald-700"},
  error: {border:"border-rose-500/40", indicator:"bg-rose-500", title:"text-rose-900", description:"text-rose-700"},
  warning: {border:"border-amber-500/40", indicator:"bg-amber-500", title:"text-amber-900", description:"text-amber-700"},
  info: {border:"border-slate-500/30", indicator:"bg-slate-500", title:"text-slate-900", description:"text-slate-600"}
};

function ToastViewport({toasts,removeToast}){
  if(!toasts || !toasts.length){
    return null;
  }
  return React.createElement("div",{className:"pointer-events-none fixed top-4 right-4 z-50 flex w-full max-w-sm flex-col gap-2 px-4"},
    toasts.map(toast=>{
      if(!toast){
        return null;
      }
      const tone = TOAST_TONES[toast.type] || TOAST_TONES.info;
      return React.createElement("div",{key:toast.id,className:`pointer-events-auto rounded-xl border ${tone.border} bg-white shadow-soft`},
        React.createElement("div",{className:"flex items-start gap-3 p-4"},
          React.createElement("span",{className:`mt-1 inline-flex h-2.5 w-2.5 shrink-0 rounded-full ${tone.indicator}`},""),
          React.createElement("div",{className:"flex-1"},
            toast.title ? React.createElement("p",{className:`text-sm font-semibold ${tone.title}`},toast.title) : null,
            toast.description ? React.createElement("p",{className:`mt-1 text-sm ${tone.description}`},toast.description) : null
          ),
          React.createElement("button",{
            type:"button",
            onClick:()=>removeToast(toast.id),
            className:"ml-2 text-xs font-semibold text-slate-400 transition hover:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2"
          },"Fechar")
        )
      );
    }).filter(Boolean)
  );
}

function ToastProvider({children}){
  const [toasts,setToasts] = useState([]);
  const timeoutMap = useRef(new Map());

  const clearTimeoutById = useCallback((id)=>{
    const timeouts = timeoutMap.current;
    if(!timeouts){
      return;
    }
    const timeoutId = timeouts.get(id);
    if(timeoutId){
      clearTimeout(timeoutId);
      timeouts.delete(id);
    }
  },[]);

  const removeToast = useCallback((id)=>{
    if(!id){
      return;
    }
    setToasts(prev=>prev.filter(toast=>toast && toast.id !== id));
    clearTimeoutById(id);
  },[clearTimeoutById]);

  const addToast = useCallback((toast)=>{
    if(!toast){
      return null;
    }
    const id = toast.id || `toast_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
    const duration = typeof toast.duration === "number" ? toast.duration : 5000;
    const entry = {
      id,
      type: toast.type || "info",
      title: toast.title || null,
      description: toast.description || null,
      duration
    };
    setToasts(prev=>[...prev,entry]);
    if(duration !== Infinity && duration > 0){
      const timeoutId = setTimeout(()=>removeToast(id),duration);
      timeoutMap.current.set(id,timeoutId);
    }
    return id;
  },[removeToast]);

  useEffect(()=>{
    return ()=>{
      const timeouts = timeoutMap.current;
      if(timeouts){
        timeouts.forEach(timeoutId=>clearTimeout(timeoutId));
        timeouts.clear();
      }
    };
  },[]);

  const contextValue = useMemo(()=>({addToast,removeToast}),[addToast,removeToast]);

  return React.createElement(ToastContext.Provider,{value:contextValue},
    children,
    React.createElement(ToastViewport,{toasts,removeToast})
  );
}

function useToast(){
  const ctx = useContext(ToastContext);
  if(!ctx){
    throw new Error("useToast deve ser usado dentro de ToastProvider");
  }
  return ctx;
}

function resolveApiUrl(base, path){
  if(!path){
    return null;
  }
  const href = String(path);
  if(/^https?:\/\//i.test(href)){
    return href;
  }
  const safeBase = (base || "").replace(/\/$/, "");
  const safePath = href.replace(/^\//, "");
  return safeBase ? `${safeBase}/${safePath}` : `/${safePath}`;
}

function JobProgressPanel({jobId,status,apiBase,onCancel,canceling}){
  if(!jobId || !status){
    return null;
  }
  const normalized = String(status.status || "").toLowerCase();
  const progress = status.progress || {};
  let percentValue = null;
  if(progress && Object.prototype.hasOwnProperty.call(progress,"percent")){
    const raw = progress.percent;
    const num = typeof raw === "number" ? raw : Number(raw);
    if(!Number.isNaN(num)){
      percentValue = Math.max(0, Math.min(100, num));
    }
  }
  if(percentValue === null && typeof progress.completed === "number" && typeof progress.total === "number" && progress.total){
    const computed = (progress.completed / progress.total) * 100;
    if(!Number.isNaN(computed)){
      percentValue = Math.max(0, Math.min(100, computed));
    }
  }
  const percentText = percentValue !== null ? `${percentValue.toFixed(Math.abs(percentValue) < 10 ? 1 : 0)}%` : null;
  const completed = typeof progress.completed === "number" ? progress.completed : null;
  const total = typeof progress.total === "number" ? progress.total : null;
  const steps = Array.isArray(progress.steps) && progress.steps.length ? progress.steps : (Array.isArray(status.logs) ? status.logs : []);
  const lastLog = Array.isArray(status.logs) && status.logs.length ? status.logs[status.logs.length - 1] : null;
  const currentMessage = status.message || (lastLog && (lastLog.message || lastLog.label || lastLog.name)) || null;
  const cancelRequested = Boolean(status.cancel_requested) || normalized === "cancelling";
  const disableCancel = cancelRequested || normalized === "success" || normalized === "error" || normalized === "cancelled";
  const logUrl = resolveApiUrl(apiBase, status.log_url);

  const renderStep = (step, index)=>{
    if(step==null){
      return null;
    }
    const key = typeof step === "object" && step ? step.id || step.name || step.label || step.timestamp || index : index;
    let level = null;
    let text = null;
    if(typeof step === "string"){
      text = step;
    }else if(typeof step === "object"){
      level = step.level || step.status_level || step.status;
      const parts = [];
      if(step.timestamp){ parts.push(step.timestamp); }
      const core = step.message || step.label || step.name;
      if(core){ parts.push(core); }
      if(step.status && step.status !== core){ parts.push(String(step.status)); }
      if(step.detail){ parts.push(step.detail); }
      if(parts.length === 0 && typeof step.completed === "number" && typeof step.total === "number"){
        parts.push(`${step.completed}/${step.total}`);
      }
      if(parts.length === 0 && step.message == null){
        try{
          parts.push(JSON.stringify(step));
        }catch(err){
          parts.push(String(step));
        }
      }
      text = parts.join(" — ");
    }
    if(!text){
      text = String(step);
    }
    const tone = String(level || "").toLowerCase();
    let toneClass = "text-slate-700";
    if(tone.includes("error")){
      toneClass = "text-rose-600";
    }else if(tone.includes("warn")){
      toneClass = "text-amber-600";
    }
    return React.createElement("li",{key:`step-${key}-${index}`,className:`text-sm ${toneClass}`},text);
  };

  return (
    React.createElement("div",{className:"mb-4 rounded-xl border border-indigo-200 bg-white p-4 shadow-soft"},
      React.createElement("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between"},
        React.createElement("div",{className:"space-y-1"},
          React.createElement("p",{className:"text-sm font-medium text-indigo-900"},`Processamento em andamento (job ${jobId})`),
          React.createElement("p",{className:"text-xs uppercase tracking-wide text-indigo-600"},`Status: ${(status.status || "").replace(/_/g," ")}`)
        ),
        React.createElement("div",{className:"flex items-center gap-2"},
          logUrl && React.createElement("a",{href:logUrl,target:"_blank",rel:"noopener",className:"text-sm font-medium text-indigo-600 hover:text-indigo-500"},"Baixar logs"),
          React.createElement("button",{
            onClick:onCancel,
            disabled:disableCancel || canceling,
            className:"rounded-lg border border-indigo-500 px-3 py-1 text-sm font-semibold text-indigo-600 hover:bg-indigo-50 disabled:cursor-not-allowed disabled:border-slate-300 disabled:text-slate-400"
          }, cancelRequested ? "Cancelamento solicitado" : (canceling ? "Cancelando..." : "Cancelar"))
        )
      ),
      percentValue !== null && React.createElement("div",{className:"mt-4"},
        React.createElement("div",{className:"mb-1 flex justify-between text-xs text-slate-500"},
          React.createElement("span",null,"Progresso"),
          React.createElement("span",null,
            percentText,
            completed !== null && total !== null ? ` · ${completed}/${total}` : ""
          )
        ),
        React.createElement("div",{className:"h-2 w-full overflow-hidden rounded-full bg-slate-200"},
          React.createElement("div",{className:"h-full bg-indigo-500 transition-all",style:{width:`${percentValue}%`}}
          )
        )
      ),
      currentMessage && React.createElement("p",{className:"mt-4 text-sm text-slate-600"}, currentMessage),
      steps.length ? React.createElement("div",{className:"mt-4 max-h-48 overflow-y-auto rounded-lg bg-slate-50 p-3"},
        React.createElement("ol",{className:"space-y-1"}, steps.slice(-12).map(renderStep).filter(Boolean))
      ) : null,
      status.log_size ? React.createElement("p",{className:"mt-3 text-xs text-slate-400"}, `Log: ${(status.log_size/1024).toFixed(1)} KB`) : null,
      cancelRequested ? React.createElement("p",{className:"mt-3 text-xs text-amber-600"},"Cancelamento em andamento — aguarde a finalização.") : null
    )
  );
}

function Badge({status}){
  const m = STATUS_COLORS[status] || STATUS_COLORS["SEM_FONTE"];
  return React.createElement("span",{className:"badge",style:{background:m.badge,color:m.text}},status||"—");
}

function useApi(base=DEFAULT_API_BASE){
  const baseUrl = base ? String(base).replace(/\/$/, "") : "";
  const get = async (path, params={})=>{
    const qs = new URLSearchParams(params).toString();
    const url = baseUrl + path + (qs?("?"+qs):"");
    const r = await fetch(url);
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  };
  const post = async (path, body)=>{
    const r = await fetch(baseUrl + path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})});
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  };
  const del = async (path, params={})=>{
    const qs = new URLSearchParams(params).toString();
    const url = baseUrl + path + (qs?("?"+qs):"");
    const r = await fetch(url,{method:"DELETE"});
    const text = await r.text();
    if(!r.ok){
      throw new Error(text || r.statusText || "Request failed");
    }
    if(!text){
      return {};
    }
    try{
      return JSON.parse(text);
    }catch(err){
      return {raw:text};
    }
  };
  const upload = async (path, formData)=>{
    const r = await fetch(baseUrl + path,{method:"POST",body:formData});
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  };
  return {get,post,del,upload};
}

function UploadModal({open,onClose,onConfirm,submitting,error}){
  const [files,setFiles] = useState({});
  const [missing,setMissing] = useState([]);
  const [messages,setMessages] = useState([]);

  useEffect(()=>{
    if(open){
      setFiles({});
      setMissing([]);
      setMessages([]);
    }
  },[open]);

  if(!open){
    return null;
  }

  const handleFileChange = (type,fileList)=>{
    const file = fileList && fileList.length ? fileList[0] : null;
    setFiles(prev=>({...prev,[type]:file}));
    setMissing(prev=>prev.filter(item=>item!==type));
  };

  const handleClose = ()=>{
    if(submitting){
      return;
    }
    onClose();
  };

  const handleSubmit = async (event)=>{
    if(event && typeof event.preventDefault === "function"){ event.preventDefault(); }
    const requiredMissing = REQUIRED_UPLOADS.filter(item=>!files[item.type]);
    if(requiredMissing.length){
      setMissing(requiredMissing.map(item=>item.type));
      setMessages(requiredMissing.map(item=>`Selecione o arquivo de ${item.label}.`));
      return;
    }
    setMessages([]);
    const formData = new FormData();
    REQUIRED_UPLOADS.forEach(item=>{
      const file = files[item.type];
      if(file){
        formData.append("files",file,file.name);
      }
    });
    try{
      await onConfirm(formData);
    }catch(err){
      setMessages([String(err)]);
    }
  };

  const combinedMessages = error ? [...messages,String(error)] : messages;

  return (
    React.createElement("div",{className:"fixed inset-0 z-50 bg-slate-900/60 flex items-center justify-center px-4"},
      React.createElement("div",{className:"relative w-full max-w-2xl rounded-2xl bg-white shadow-2xl"},
        React.createElement("button",{className:"absolute right-4 top-4 text-slate-400 hover:text-slate-600",onClick:handleClose},
          "✕"
        ),
        React.createElement("form",{onSubmit:handleSubmit,className:"p-6 md:p-8"},
          React.createElement("div",{className:"mb-6 space-y-2"},
            React.createElement("h3",{className:"text-xl font-semibold text-slate-900"},"Enviar CSVs"),
            React.createElement("p",{className:"text-sm text-slate-600"},"Selecione os arquivos CSV necessários para iniciar o processamento."),
          ),
          React.createElement("div",{className:"grid gap-4"},
            REQUIRED_UPLOADS.map(item=>{
              const hasError = missing.includes(item.type);
              const borderClass = hasError ? "border-rose-400 focus:border-rose-500 focus:ring-rose-200" : "border-slate-200 focus:border-slate-400 focus:ring-slate-200";
              return React.createElement("label",{key:item.type,className:"flex flex-col gap-2 rounded-xl border bg-slate-50/60 p-4"},
                React.createElement("div",{className:"flex flex-col"},
                  React.createElement("span",{className:"text-sm font-semibold text-slate-700"}, item.label),
                  React.createElement("span",{className:"text-xs text-slate-500"}, item.hint)
                ),
                React.createElement("input",{
                  type:"file",
                  accept:".csv",
                  className:`block w-full rounded-lg border bg-white px-3 py-2 text-sm shadow-sm focus:outline-none ${borderClass}`,
                  onChange:e=>handleFileChange(item.type,e.target.files)
                })
              );
            })
          ),
          combinedMessages.length ? React.createElement("div",{className:"mt-6 space-y-1 rounded-lg border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700"},
            combinedMessages.map((msg,idx)=>React.createElement("div",{key:idx},msg))
          ) : null,
          React.createElement("div",{className:"mt-8 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end"},
            React.createElement("button",{
              type:"button",
              onClick:handleClose,
              disabled:submitting,
              className:"rounded-lg bg-slate-200 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-300 disabled:opacity-60"
            },"Cancelar"),
            React.createElement("button",{
              type:"submit",
              disabled:submitting,
              className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
            }, submitting?"Enviando...":"Enviar e processar")
          )
        )
      )
    )
  );
}

function Toolbar({stats,filters,onStatusFilter,onFilterChange,onReload,onExportX,onExportP,onClearFilters,onClearData,clearing,loading,disabled}){
  const statusValue = (filters?.status || "");
  const statusCards = [
    {key:"TOTAL",label:"Total",valueKey:"TOTAL",statusValue:"",valueClass:"text-xl font-bold"},
    {key:"OK",label:"OK",valueKey:"OK",statusValue:"OK",valueClass:"text-xl font-bold text-emerald-700"},
    {key:"ALERTA",label:"Alertas",valueKey:"ALERTA",statusValue:"ALERTA",valueClass:"text-xl font-bold text-amber-700"},
    {key:"DIVERGENCIA",label:"Divergências",valueKey:"DIVERGENCIA",statusValue:"DIVERGENCIA",valueClass:"text-xl font-bold text-rose-700"},
    {key:"SEM_FONTE",label:"Sem Fonte",valueKey:"SEM_FONTE",statusValue:"SEM_FONTE",valueClass:"text-xl font-bold text-slate-700"},
    {key:"SEM_SUCESSOR",label:"Sem Sucessor",valueKey:"SEM_SUCESSOR",statusValue:"SEM_SUCESSOR",valueClass:"text-xl font-bold text-slate-700"}
  ];
  return (
    React.createElement("div",{className:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between mb-4"},
      React.createElement("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3"},
        statusCards.map(card=>{
          const isActive = statusValue === (card.statusValue || "");
          const baseClass = "p-3 rounded-xl bg-white shadow-soft border-2 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-60";
          const stateClass = isActive ? " border-indigo-500 bg-indigo-50" : " border-transparent hover:border-slate-200";
          return React.createElement("button",{
            key: card.key,
            type:"button",
            className: baseClass + stateClass,
            onClick: ()=>{ if(onStatusFilter){ onStatusFilter(card.statusValue || ""); } },
            disabled,
            role:"button",
            "aria-pressed": isActive
          },[
            React.createElement("div",{key:"label",className:"text-xs text-slate-500"}, card.label),
            React.createElement("div",{key:"value",className: card.valueClass}, stats?.[card.valueKey] ?? "—")
          ]);
        })
      ),
      React.createElement("div",{className:"flex flex-col gap-2 md:w-[520px]"},
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("select",{className:"px-2 py-2 rounded-lg bg-white border w-40 disabled:opacity-50",value:filters.status,disabled,onChange:e=>onStatusFilter && onStatusFilter(e.target.value)},
            React.createElement("option",{value:""},"Status — todos"),
            ["OK","ALERTA","DIVERGENCIA","SEM_FONTE","SEM_SUCESSOR"].map(s=>React.createElement("option",{key:s,value:s},s))
          ),
          React.createElement("select",{className:"px-2 py-2 rounded-lg bg-white border w-40 disabled:opacity-50",value:filters.fonte_tipo,disabled,onChange:e=>onFilterChange && onFilterChange("fonte_tipo", e.target.value)},
            React.createElement("option",{value:""},"Fonte — todas"),
            ["ENTRADA","SAIDA","SERVICO"].map(s=>React.createElement("option",{key:s,value:s},s))
          ),
          React.createElement("input",{className:"px-3 py-2 rounded-lg bg-white border flex-1 disabled:opacity-50",placeholder:"CFOP",value:filters.cfop,disabled,onChange:e=>onFilterChange && onFilterChange("cfop", e.target.value)})
        ),
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("input",{className:"px-3 py-2 rounded-lg bg-white border flex-1 disabled:opacity-50",placeholder:"Buscar (histórico, doc, tags)...",value:filters.q,disabled,onChange:e=>onFilterChange && onFilterChange("q", e.target.value),onKeyDown:e=>{if(e.key==="Escape"){ e.preventDefault(); e.stopPropagation(); if(onFilterChange){ onFilterChange("q",""); } e.target.blur(); }}}),
          React.createElement("button",{onClick:onReload,disabled:loading||disabled,className:"px-3 py-2 rounded-lg bg-slate-900 text-white disabled:opacity-50 disabled:cursor-not-allowed"}, loading?"Carregando...":"Atualizar")
        ),
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("button",{onClick:onClearFilters,disabled:disabled,className:"px-3 py-2 rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed"}, "Limpar filtros"),
          React.createElement("button",{onClick:onExportX,disabled:disabled,className:"px-3 py-2 rounded-lg bg-emerald-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"}, "Exportar Excel"),
          React.createElement("button",{onClick:onExportP,disabled:disabled,className:"px-3 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"}, "Exportar PDF"),
          React.createElement("button",{onClick:onClearData,disabled:disabled||clearing,className:"px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-500 disabled:opacity-50 disabled:cursor-not-allowed"}, clearing?"Limpando...":"Limpar dados"),
          React.createElement("a",{href:"/files/",target:"_blank",className:"px-3 py-2 rounded-lg bg-slate-200"}, "Arquivos")
        )
      )
    )
  );
}

function InspectorPanel({row,onClose,onMark,onReset}){
  if(!row){
    return null;
  }
  const info = [
    {label: "Status atual", value: row.status || row["match.status"]},
    {label: "Estrategia", value: row["match.strategy"]},
    {label: "Score", value: row["match.score"]},
    {label: "Sucessor", value: row["S.doc"]},
    {label: "Fonte", value: row["F.doc"]},
    {label: "Delta Valor", value: row["delta.valor"]},
    {label: "Delta Dias", value: row["delta.dias"]},
    {label: "Motivos", value: row.motivos}
  ];
  return React.createElement("div",{className:"mt-6 bg-white shadow-soft rounded-xl border border-slate-200"},
    React.createElement("div",{className:"flex items-start justify-between px-4 py-3 border-b border-slate-200"},
      React.createElement("h3",{className:"text-lg font-semibold"},"Detalhes da selecao"),
      React.createElement("button",{className:"text-sm text-slate-500 hover:text-slate-700",onClick:onClose},"Fechar")
    ),
    React.createElement("div",{className:"px-4 py-4 grid gap-3 md:grid-cols-2"},
      info.map((item,idx)=>React.createElement("div",{key:idx},
        React.createElement("div",{className:"text-xs uppercase tracking-wide text-slate-500"}, item.label),
        React.createElement("div",{className:"text-sm font-medium text-slate-800 break-words"}, item.value || "-")
      ))
    ),
    React.createElement("div",{className:"px-4 pb-4 flex flex-wrap gap-2"},
      React.createElement("button",{className:"px-3 py-1 rounded bg-emerald-100 text-emerald-800 text-sm",onClick:()=>onMark(row,"OK")},"Marcar OK"),
      React.createElement("button",{className:"px-3 py-1 rounded bg-rose-100 text-rose-800 text-sm",onClick:()=>onMark(row,"DIVERGENCIA")},"Marcar Divergencia"),
      React.createElement("button",{className:"px-3 py-1 rounded bg-slate-200 text-slate-700 text-sm",onClick:()=>onReset(row)},"Reverter")
    )
  );
}

function Table({columns,items,resolveRowId,selectedRowId,sortBy,setSortBy,sortDir,setSortDir,onInspect,onManualStatus,onResetStatus}){
  const setSort = (id)=>{
    if(sortBy===id){ setSortDir(sortDir==="asc"?"desc":"asc"); } else { setSortBy(id); setSortDir("desc"); }
  };
  return (
    React.createElement("div",{className:"overflow-auto rounded-xl shadow-soft border bg-white"},
      React.createElement("table",{className:"min-w-[1200px] w-full table-sticky"},
        React.createElement("thead",null,
          React.createElement("tr",null,
            React.createElement("th",{className:"text-left px-3 py-2 w-28"},"Status"),
            React.createElement("th",{className:"text-left px-3 py-2 w-44"},"Acoes"),
            columns.map(col=>React.createElement("th",{key:col.id,className:"text-left px-3 py-2 cursor-pointer",onClick:()=>setSort(col.id)}, col.label||col.id))
          )
        ),
        React.createElement("tbody",null,
          items.map((r,idx)=>{
            const s = (r.status||"").toUpperCase();
            const auto = (r.score ?? 0) >= 70;
            const cls = s==="OK"?"row-ok":(s==="ALERTA"?"row-alerta":(s==="DIVERGENCIA"?"row-div":"row-neutro"));
            const rowKey = (resolveRowId && resolveRowId(r)) ?? idx;
            const isSelected = selectedRowId && rowKey === selectedRowId;
            return React.createElement("tr",{key:rowKey,className:cls + (isSelected?" ring-2 ring-indigo-400":"") + " hover:bg-slate-100",style: auto?{outline:"2px solid #2563eb",outlineOffset:"-2px"}:{} ,onClick:()=>onInspect && onInspect(r)},
              React.createElement("td",{className:"px-3 py-2 align-top"}, React.createElement(Badge,{status:s})),
              React.createElement("td",{className:"px-3 py-2 align-top"},
                React.createElement("div",{className:"flex flex-col gap-1"},
                  React.createElement("button",{className:"px-2 py-1 rounded bg-emerald-100 text-emerald-800 text-xs",onClick:(e)=>{e.stopPropagation(); onManualStatus && onManualStatus(r,"OK")}},"Marcar OK"),
                  React.createElement("button",{className:"px-2 py-1 rounded bg-rose-100 text-rose-800 text-xs",onClick:(e)=>{e.stopPropagation(); onManualStatus && onManualStatus(r,"DIVERGENCIA")}},"Marcar Divergencia"),
                  React.createElement("button",{className:"px-2 py-1 rounded bg-slate-200 text-slate-700 text-xs",disabled:!r._manual,onClick:(e)=>{e.stopPropagation(); onResetStatus && onResetStatus(r)}},"Reverter")
                )
              ),
              columns.map(col=>{
                const val = r[col.id];
                const isMoney = (col.type==="money");
                const isNum = (col.type==="number");
                const txt = (val==null)?"":(isMoney?formatBRL(val):(isNum?String(val):String(val)));
                return React.createElement("td",{key:col.id,className:"px-3 py-2 align-top "+(isMoney||isNum?"cell-mono":"")},
                  txt
                );
              })
            );
          })
        )
      )
    )
  );
}

function Paginator({offset,setOffset,limit,setLimit,total,go}){
  const canPrev = offset>0;
  const canNext = offset+limit < total;
  const page = Math.floor(offset/limit)+1;
  const pages = Math.max(1, Math.ceil(total/limit));
  return (
    React.createElement("div",{className:"flex items-center justify-between mt-3"},
      React.createElement("div",null, `Mostrando ${Math.min(total, offset+1)}-${Math.min(total, offset+limit)} de ${total}`),
      React.createElement("div",{className:"flex items-center gap-2"},
        React.createElement("button",{disabled:!canPrev,onClick:()=>{ if(!canPrev) return; const nextOffset = Math.max(0, offset-limit); if(typeof go === "function"){ go(nextOffset); } },className:"px-3 py-1 rounded bg-slate-200 disabled:opacity-50"},"<"),
        React.createElement("span",null, `Pagina ${page}/${pages}`),
        React.createElement("button",{disabled:!canNext,onClick:()=>{ if(!canNext) return; const nextOffset = offset+limit; if(typeof go === "function"){ go(nextOffset); } },className:"px-3 py-1 rounded bg-slate-200 disabled:opacity-50"},">"),
        React.createElement("select",{className:"px-2 py-1 rounded bg-white border",value:limit,onChange:e=>{const nextLimit = parseInt(e.target.value,10); setOffset(0); setLimit(nextLimit);}},
          [50,100,200,500,1000].map(n=>React.createElement("option",{key:n,value:n}, n))
        )
      )
    )
  );
}

function formatBRL(x){
  const n = Number(x);
  if(Number.isNaN(n)) return x==null?"":String(x);
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function computeToolbarStats(meta){
  const stats = meta?.stats;
  if(!stats){
    return null;
  }
  const uppercase = Object.entries(STATUS_KEY).reduce((acc,[upper,lower])=>{
    const value = stats[lower];
    acc[upper] = typeof value === "number" ? value : Number(value) || 0;
    return acc;
  },{});
  const total = Object.values(uppercase).reduce((sum,val)=> sum + (typeof val === "number" ? val : Number(val) || 0), 0);
  return {...stats, ...uppercase, TOTAL: total};
}

function App(){
  const api = useApi(); // ajuste `window.UI_API_BASE` ou use ?api= para apontar para outro host/porta
  const {addToast} = useToast();
  const [schema,setSchema] = useState(null);
  const [meta,setMeta] = useState(null);
  const [items,setItems] = useState([]);
  const [total,setTotal] = useState(0);
  const [loading,setLoading] = useState(false);
  const [error,setError] = useState(null);
  const [filters,setFilters] = useState(()=>createDefaultFilters());
  const [sortBy,setSortBy] = useState("score");
  const [sortDir,setSortDir] = useState("desc");
  const [limit,setLimit] = useState(100);
  const [offset,setOffset] = useState(0);
  const [selectedRow,setSelectedRow] = useState(null);
  const [showUploadModal,setShowUploadModal] = useState(false);
  const [uploading,setUploading] = useState(false);
  const [uploadError,setUploadError] = useState(null);
  const [currentJobId,setCurrentJobId] = useState(null);
  const [jobStatus,setJobStatus] = useState(null);
  const [jobCanceling,setJobCanceling] = useState(false);
  const [clearingData,setClearingData] = useState(false);
  const normalizedJobStatus = String(jobStatus?.status || "").toLowerCase();
  const jobRunning = Boolean(currentJobId) && JOB_ACTIVE_STATES.has(normalizedJobStatus);
  const skipNextAutoLoad = useRef(false);

  const resolveRowId = useCallback((entry)=> entry?.id ?? [entry?.sucessor_idx, entry?.fonte_tipo, entry?.fonte_idx].filter(Boolean).join('-'), []);

  const handleInspect = useCallback((row)=>{
    if(!row){
      setSelectedRow(null);
      return;
    }
    setSelectedRow(row);
  },[]);

  useEffect(()=>{
    if(!selectedRow){
      return;
    }
    const rowKey = resolveRowId(selectedRow);
    const latest = items.find(item=> resolveRowId(item) === rowKey);
    if(!latest){
      setSelectedRow(null);
    }else if(latest !== selectedRow){
      setSelectedRow(latest);
    }
  },[items, resolveRowId, selectedRow]);

  const selectedRowId = selectedRow ? resolveRowId(selectedRow) : null;

  const tableColumns = useMemo(() => schema?.columns?.length ? schema.columns : DEFAULT_COLUMNS, [schema]);

  const loadMeta = useCallback(async ()=>{
    try{
      const s = await api.get("/api/schema");
      setSchema(s);
      const m = await api.get("/api/meta");
      setMeta(m);
    }catch(e){ console.error(e); }
  },[api]);

  const loadGrid = useCallback(async (nextOffset, nextFilters)=>{
    const hasOverride = typeof nextOffset === "number" && !Number.isNaN(nextOffset);
    const targetOffset = hasOverride ? Math.max(0, nextOffset) : offset;
    if(hasOverride && nextOffset !== offset){
      skipNextAutoLoad.current = true;
      setOffset(targetOffset);
    }
    const appliedFilters = nextFilters || filters;
    setLoading(true); setError(null);
    try{
      const params = {
        limit,
        offset: targetOffset,
        status: appliedFilters.status || undefined,
        fonte_tipo: appliedFilters.fonte_tipo || undefined,
        cfop: appliedFilters.cfop || undefined,
        q: appliedFilters.q || undefined,
        sort_by: sortBy || undefined,
        sort_dir: sortDir || undefined
      };
      const res = await api.get("/api/grid", params);
      setItems(res.items || []);
      setTotal(res.total_filtered || 0);
    }catch(e){ setError(String(e)); setItems([]); setTotal(0); }
    finally{ setLoading(false); }
  },[api, filters, sortBy, sortDir, limit, offset, skipNextAutoLoad]);

  useEffect(()=>{ loadMeta(); },[loadMeta]);
  useEffect(()=>{
    if(skipNextAutoLoad.current){
      skipNextAutoLoad.current = false;
      return;
    }
    loadGrid();
  },[loadGrid]);

  const handleStatusFilter = useCallback((nextStatus)=>{
    const normalized = nextStatus ? String(nextStatus).toUpperCase() : "";
    setOffset(0);
    setFilters(prev=>{
      const currentStatus = prev?.status || "";
      if(currentStatus === normalized){
        return prev;
      }
      return {...prev, status: normalized};
    });
  },[]);

  const handleFilterChange = useCallback((field, value)=>{
    setOffset(0);
    setFilters(prev=>{
      if(!prev || prev[field] === value){
        return prev;
      }
      return {...prev, [field]: value};
    });
  },[]);

  const handleClearFilters = useCallback(()=>{
    const cleared = createDefaultFilters();
    setOffset(0);
    setFilters(cleared);
    loadGrid(0, cleared);
  },[loadGrid]);

  const handleClearData = useCallback(async ()=>{
    if(clearingData){
      return;
    }
    const confirmed = window.confirm("Tem certeza que deseja limpar os dados processados? Esta ação não pode ser desfeita.");
    if(!confirmed){
      return;
    }
    setClearingData(true);
    setError(null);
    try{
      await api.del("/api/data");
      setMeta(null);
      setItems([]);
      setTotal(0);
      setSelectedRow(null);
      addToast({
        type:"success",
        title:"Dados limpos",
        description:"Os dados processados foram removidos."
      });
    }catch(err){
      console.error("Falha ao limpar dados", err);
      const message = err && err.message ? err.message : String(err);
      addToast({
        type:"error",
        title:"Erro ao limpar dados",
        description: message
      });
    }finally{
      setClearingData(false);
    }
  },[addToast, api, clearingData]);

  const exportX = async ()=>{
    try{
      const out = "relatorio_conferencia.xlsx";
      const res = await api.post("/api/export/xlsx",{grid:"reconc_grid.csv",sem_fonte:"reconc_sem_fonte.csv",sem_sucessor:"reconc_sem_sucessor.csv",out});
      if(res.download){ window.open(res.download,"_blank"); }
    }catch(e){ alert("Falha no export XLSX: "+e); }
  };
  const exportP = async ()=>{
    try{
      const out = "relatorio_conferencia.pdf";
      const res = await api.post("/api/export/pdf",{grid:"reconc_grid.csv",out,cliente:"Cliente",periodo:"Periodo"});
      const link = res.download || res.download_html;
      if(link){ window.open(link,"_blank"); }
    }catch(e){ alert("Falha no export PDF: "+e); }
  };

  const handleCancelJob = useCallback(async ()=>{
    if(!currentJobId || jobCanceling){
      return;
    }
    setJobCanceling(true);
    try{
      const res = await api.del(`/api/process/${currentJobId}`);
      setJobStatus(prev=>{
        if(prev && typeof prev === "object"){
          return {...prev, ...res};
        }
        return res;
      });
    }catch(err){
      console.error("Falha ao solicitar cancelamento do job", err);
      const message = err && err.message ? err.message : String(err);
      alert("Não foi possível cancelar o processamento: " + message);
    }finally{
      setJobCanceling(false);
    }
  },[api,currentJobId,jobCanceling]);

  const openUploadModal = ()=>{
    setUploadError(null);
    setShowUploadModal(true);
  };

  const closeUploadModal = ()=>{
    setShowUploadModal(false);
    setUploadError(null);
  };

  const handleUploadConfirm = async (formData)=>{
    setUploading(true);
    setUploadError(null);
    try{
      const uploadRes = await api.upload("/api/uploads",formData);
      const jobId = uploadRes?.job_id;
      if(jobId){
        let initialStatus = uploadRes?.status || null;
        try{
          const processRes = await api.post("/api/process",{job_id: jobId});
          initialStatus = processRes?.status || initialStatus || "running";
        }catch(processErr){
          const message = processErr && processErr.message ? processErr.message : String(processErr);
          setUploadError(message);
          return;
        }
        setCurrentJobId(jobId);
        setJobCanceling(false);
        setJobStatus({job_id: jobId, status: initialStatus});
        if(String(initialStatus||"").toLowerCase() === "success"){
          await loadMeta();
          await loadGrid(0);
          setCurrentJobId(null);
          setJobStatus(null);
        }
      }else{
        await loadMeta();
        await loadGrid(0);
      }
      setShowUploadModal(false);
    }catch(err){
      const message = err && err.message ? err.message : String(err);
      setUploadError(message);
    }finally{
      setUploading(false);
    }
  };

  const updateStats = (prevStatus, nextStatus)=>{
    if(!prevStatus || !nextStatus || prevStatus===nextStatus) return;
    setMeta(current=>{
      if(!current || !current.stats) return current;
      const stats = {...current.stats};
      const prevKey = STATUS_KEY[prevStatus];
      const nextKey = STATUS_KEY[nextStatus];
      if(prevKey && stats[prevKey]!=null){ stats[prevKey] = Math.max(0, stats[prevKey]-1); }
      if(nextKey){ stats[nextKey] = (stats[nextKey]||0)+1; }
      return {...current, stats};
    });
  };

  const handleManualStatus = async (row, nextStatus)=>{
    if(!row) return;
    const targetStatus = (nextStatus || "").toUpperCase();
    if(!targetStatus) return;
    const rowKey = resolveRowId(row);
    if(!rowKey) return;
    const current = items.find(item=> resolveRowId(item) === rowKey) || row;
    const previousStatus = (current?.status || current?.["match.status"] || "").toUpperCase();
    const originalStatus = (current?.original_status || previousStatus || "").toUpperCase();
    try{
      await api.post("/api/manual-status",{
        row_id: rowKey,
        status: targetStatus,
        original_status: originalStatus
      });
    }catch(e){
      console.error("Falha ao salvar override manual", e);
      alert("Falha ao salvar ajuste manual: " + e);
      return;
    }
    let updatedRow = null;
    setItems(prev=>prev.map(item=>{
      const key = resolveRowId(item);
      if(key !== rowKey) return item;
      const motivos = new Set((item.motivos || "").split(";").filter(Boolean));
      motivos.add("ajuste_manual");
      const updated = {
        ...item,
        status: targetStatus,
        "match.status": targetStatus,
        motivos: Array.from(motivos).join(";"),
        _manual: true,
        original_status: item.original_status || originalStatus
      };
      updatedRow = updated;
      return updated;
    }));
    if(updatedRow){ setSelectedRow(updatedRow); }
    if(previousStatus){ updateStats(previousStatus, targetStatus); }
  };

  const handleResetStatus = async (row)=>{
    if(!row) return;
    const rowKey = resolveRowId(row);
    if(!rowKey) return;
    const current = items.find(item=> resolveRowId(item) === rowKey) || row;
    const previousStatus = (current?.status || current?.["match.status"] || "").toUpperCase();
    const originalStatus = (current?.original_status || current?.["match.status"] || current?.status || "").toUpperCase();
    try{
      await api.del("/api/manual-status",{row_id: rowKey});
    }catch(e){
      console.error("Falha ao remover override manual", e);
      alert("Falha ao remover ajuste manual: " + e);
      return;
    }
    let updatedRow = null;
    setItems(prev=>prev.map(item=>{
      const key = resolveRowId(item);
      if(key !== rowKey) return item;
      const motivos = (item.motivos || "").split(";").filter(Boolean).filter(tag=>tag !== "ajuste_manual");
      const baseStatus = (item.original_status || item["match.status"] || item.status || originalStatus || "").toUpperCase();
      const updated = {
        ...item,
        status: baseStatus,
        "match.status": baseStatus,
        motivos: motivos.join(";"),
        _manual: false
      };
      delete updated.original_status;
      updatedRow = updated;
      return updated;
    }));
    if(updatedRow){ setSelectedRow(updatedRow); }
    if(previousStatus && originalStatus){ updateStats(previousStatus, originalStatus); }
  };

  useEffect(()=>{
    if(!currentJobId){
      return;
    }
    let cancelled = false;
    let timerId = null;
    const poll = async ()=>{
      try{
        const res = await api.get(`/api/process/${currentJobId}`);
        if(cancelled){
          return;
        }
        setJobStatus(res);
        const status = res?.status || null;
        const normalized = String(status||"").toLowerCase();
        if(normalized === "success"){
          await Promise.all([loadMeta(), loadGrid(0)]);
          if(cancelled){
            return;
          }
          if(timerId){ clearInterval(timerId); timerId = null; }
          setCurrentJobId(null);
          setJobStatus(null);
          setJobCanceling(false);
        }else if(normalized === "failed" || normalized === "error"){
          if(timerId){ clearInterval(timerId); timerId = null; }
          setCurrentJobId(null);
          setJobStatus(null);
          setJobCanceling(false);
          if(!cancelled){
            const lastLog = Array.isArray(res?.logs) && res.logs.length ? res.logs[res.logs.length-1] : null;
            const message = res?.message || lastLog?.message || lastLog?.label;
            if(message){
              alert(`Processamento falhou: ${message}`);
            }else{
              alert("Processamento falhou.");
            }
          }
        }else if(normalized === "cancelled"){
          if(timerId){ clearInterval(timerId); timerId = null; }
          setCurrentJobId(null);
          setJobStatus(null);
          setJobCanceling(false);
          if(!cancelled){
            alert("Processamento cancelado.");
          }
        }
      }catch(pollErr){
        console.error("Falha no polling do processamento", pollErr);
      }
    };
    poll();
    timerId = setInterval(poll, 4000);
    return ()=>{
      cancelled = true;
      if(timerId){ clearInterval(timerId); }
    };
  },[api, currentJobId, loadGrid, loadMeta]);

  const toolbarStats = useMemo(()=> computeToolbarStats(meta),[meta]);
  
  return (

    React.createElement("div",{className:"max-w-[1400px] mx-auto p-4 md:p-6"},
      React.createElement("div",{className:"mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between"},
        React.createElement("div",{className:"space-y-1"},
          React.createElement("h2",{className:"text-2xl font-semibold"},"App de Conferencia - UI"),
          React.createElement("p",{className:"text-slate-600"},"Carrega ", React.createElement("code",null,"ui_grid.jsonl"), " do servidor local e exibe a grade com filtros e exports.")
        ),
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("button",{
            onClick:openUploadModal,
            disabled:uploading || jobRunning,
            className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-soft hover:bg-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
          }, (uploading || jobRunning)?"Processando...":"Processar")
        )
      ),
      currentJobId && jobStatus ? React.createElement(JobProgressPanel,{
        jobId: currentJobId,
        status: jobStatus,
        apiBase: DEFAULT_API_BASE,
        onCancel: handleCancelJob,
        canceling: jobCanceling
      }) : null,
      React.createElement(Toolbar,{
        stats: toolbarStats ?? computeToolbarStats(meta),
        filters,
        onStatusFilter: handleStatusFilter,
        onFilterChange: handleFilterChange,
        onReload:()=> loadGrid(0),
        onExportX: exportX,
        onExportP: exportP,
        onClearFilters: handleClearFilters,
        onClearData: handleClearData,
        clearing: clearingData,
        loading,
        disabled: jobRunning
      }),
      error && React.createElement("div",{className:"p-3 rounded bg-rose-100 text-rose-800 mb-3"}, String(error)),
      React.createElement(Table,{
        columns: tableColumns,items,resolveRowId,selectedRowId,sortBy,setSortBy,sortDir,setSortDir,onInspect: handleInspect,onManualStatus: handleManualStatus,onResetStatus: handleResetStatus
      }),
      React.createElement(InspectorPanel,{
        row: selectedRow,
        onClose: ()=>setSelectedRow(null),
        onMark: handleManualStatus,
        onReset: handleResetStatus
      }),
      React.createElement(Paginator,{offset,setOffset,limit,setLimit,total,go:loadGrid}),
      React.createElement(UploadModal,{
        open: showUploadModal,
        onClose: closeUploadModal,
        onConfirm: handleUploadConfirm,
        submitting: uploading,
        error: uploadError
      })
    )
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(ToastProvider,null,React.createElement(App)));
</script>
</body>
</html>
