<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>App de Conferencia - UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <style>
    .badge{border-radius:9999px;padding:.125rem .5rem;font-size:.75rem;font-weight:600;display:inline-block}
    .cell-mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .row-ok{background:#d1fae5}
    .row-alerta{background:#fef3c7}
    .row-div{background:#fee2e2}
    .row-neutro{background:#e5e7eb}
    .outline-auto{outline:2px solid #2563eb}
    .shadow-soft{box-shadow:0 1px 2px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.04)}
    .table-sticky thead th{position:sticky;top:0;background:#0f172a;color:#fff;z-index:1}
    .table-sticky thead th{font-weight:600}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div id="root"></div>

<script type="text/javascript">
const {useState,useEffect,useMemo,useCallback,Fragment} = React;

const DEFAULT_API_BASE = (() => {
  if (typeof window !== "undefined") {
    if (typeof window.UI_API_BASE !== "undefined") {
      const configured = String(window.UI_API_BASE);
      return configured.replace(/\/$/, "");
    }
    try {
      const params = new URLSearchParams(window.location.search);
      const param = params.get("api");
      if (param) {
        return param.replace(/\/$/, "");
      }
    } catch (err) {
      console.warn("Falha ao ler parametro ?api:", err);
    }
  }
  return "http://localhost:8000";
})();
// Ajuste `window.UI_API_BASE` ou adicione ?api=http://host:porta na URL antes de carregar o arquivo para definir outro endpoint.

const STATUS_COLORS = {
  "OK": {bg:"#d1fae5", badge:"#16a34a", text:"#052e16"},
  "ALERTA": {bg:"#fef3c7", badge:"#f59e0b", text:"#451a03"},
  "DIVERGENCIA": {bg:"#fee2e2", badge:"#dc2626", text:"#450a0a"},
  "SEM_FONTE": {bg:"#e5e7eb", badge:"#6b7280", text:"#111827"},
  "SEM_SUCESSOR": {bg:"#e5e7eb", badge:"#6b7280", text:"#111827"},
};

const STATUS_KEY = {
  OK: 'ok',
  ALERTA: 'alerta',
  DIVERGENCIA: 'divergencia',
  SEM_FONTE: 'sem_fonte',
  SEM_SUCESSOR: 'sem_sucessor'
};

function Badge({status}){
  const m = STATUS_COLORS[status] || STATUS_COLORS["SEM_FONTE"];
  return React.createElement("span",{className:"badge",style:{background:m.badge,color:m.text}},status||"—");
}

function useApi(base=DEFAULT_API_BASE){
  const baseUrl = base ? String(base).replace(/\/$/, "") : "";
  const get = async (path, params={})=>{
    const qs = new URLSearchParams(params).toString();
    const url = baseUrl + path + (qs?("?"+qs):"");
    const r = await fetch(url);
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  };
  const post = async (path, body)=>{
    const r = await fetch(baseUrl + path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})});
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  };
  return {get,post};
}

function Toolbar({stats,filters,setFilters,onReload,onExportX,onExportP,loading}){
  return (
    React.createElement("div",{className:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between mb-4"},
      React.createElement("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3"},
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Total"),
          React.createElement("div",{className:"text-xl font-bold"}, stats?.TOTAL ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"OK"),
          React.createElement("div",{className:"text-xl font-bold text-emerald-700"}, stats?.OK ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Alertas"),
          React.createElement("div",{className:"text-xl font-bold text-amber-700"}, stats?.ALERTA ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Divergências"),
          React.createElement("div",{className:"text-xl font-bold text-rose-700"}, stats?.DIVERGENCIA ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Sem Fonte"),
          React.createElement("div",{className:"text-xl font-bold text-slate-700"}, stats?.SEM_FONTE ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Sem Sucessor"),
          React.createElement("div",{className:"text-xl font-bold text-slate-700"}, stats?.SEM_SUCESSOR ?? "—")
        ),
      ),
      React.createElement("div",{className:"flex flex-col gap-2 md:w-[520px]"},
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("select",{className:"px-2 py-2 rounded-lg bg-white border w-40",value:filters.status,onChange:e=>setFilters(f=>({...f,status:e.target.value}))},
            React.createElement("option",{value:""},"Status — todos"),
            ["OK","ALERTA","DIVERGENCIA","SEM_FONTE","SEM_SUCESSOR"].map(s=>React.createElement("option",{key:s,value:s},s))
          ),
          React.createElement("select",{className:"px-2 py-2 rounded-lg bg-white border w-40",value:filters.fonte_tipo,onChange:e=>setFilters(f=>({...f,fonte_tipo:e.target.value}))},
            React.createElement("option",{value:""},"Fonte — todas"),
            ["ENTRADA","SAIDA","SERVICO"].map(s=>React.createElement("option",{key:s,value:s},s))
          ),
          React.createElement("input",{className:"px-3 py-2 rounded-lg bg-white border flex-1",placeholder:"CFOP",value:filters.cfop,onChange:e=>setFilters(f=>({...f,cfop:e.target.value}))})
        ),
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("input",{className:"px-3 py-2 rounded-lg bg-white border flex-1",placeholder:"Buscar (histórico, doc, tags)...",value:filters.q,onChange:e=>setFilters(f=>({...f,q:e.target.value}))}),
          React.createElement("button",{onClick:onReload,disabled:loading,className:"px-3 py-2 rounded-lg bg-slate-900 text-white disabled:opacity-50"}, loading?"Carregando...":"Atualizar")
        ),
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("button",{onClick:onExportX,className:"px-3 py-2 rounded-lg bg-emerald-600 text-white"}, "Exportar Excel"),
          React.createElement("button",{onClick:onExportP,className:"px-3 py-2 rounded-lg bg-indigo-600 text-white"}, "Exportar PDF"),
          React.createElement("a",{href:"/files/",target:"_blank",className:"px-3 py-2 rounded-lg bg-slate-200"}, "Arquivos")
        )
      )
    )
  );
}

function InspectorPanel({row,onClose,onMark,onReset}){
  if(!row){
    return null;
  }
  const info = [
    {label: "Status atual", value: row.status || row["match.status"]},
    {label: "Estrategia", value: row["match.strategy"]},
    {label: "Score", value: row["match.score"]},
    {label: "Sucessor", value: row["S.doc"]},
    {label: "Fonte", value: row["F.doc"]},
    {label: "Delta Valor", value: row["delta.valor"]},
    {label: "Delta Dias", value: row["delta.dias"]},
    {label: "Motivos", value: row.motivos}
  ];
  return React.createElement("div",{className:"mt-6 bg-white shadow-soft rounded-xl border border-slate-200"},
    React.createElement("div",{className:"flex items-start justify-between px-4 py-3 border-b border-slate-200"},
      React.createElement("h3",{className:"text-lg font-semibold"},"Detalhes da selecao"),
      React.createElement("button",{className:"text-sm text-slate-500 hover:text-slate-700",onClick:onClose},"Fechar")
    ),
    React.createElement("div",{className:"px-4 py-4 grid gap-3 md:grid-cols-2"},
      info.map((item,idx)=>React.createElement("div",{key:idx},
        React.createElement("div",{className:"text-xs uppercase tracking-wide text-slate-500"}, item.label),
        React.createElement("div",{className:"text-sm font-medium text-slate-800 break-words"}, item.value || "-")
      ))
    ),
    React.createElement("div",{className:"px-4 pb-4 flex flex-wrap gap-2"},
      React.createElement("button",{className:"px-3 py-1 rounded bg-emerald-100 text-emerald-800 text-sm",onClick:()=>onMark(row,"OK")},"Marcar OK"),
      React.createElement("button",{className:"px-3 py-1 rounded bg-rose-100 text-rose-800 text-sm",onClick:()=>onMark(row,"DIVERGENCIA")},"Marcar Divergencia"),
      React.createElement("button",{className:"px-3 py-1 rounded bg-slate-200 text-slate-700 text-sm",onClick:()=>onReset(row)},"Reverter")
    )
  );
}

function Table({columns,items,resolveRowId,selectedRowId,sortBy,setSortBy,sortDir,setSortDir,onInspect,onManualStatus,onResetStatus}){
  const setSort = (id)=>{
    if(sortBy===id){ setSortDir(sortDir==="asc"?"desc":"asc"); } else { setSortBy(id); setSortDir("desc"); }
  };
  return (
    React.createElement("div",{className:"overflow-auto rounded-xl shadow-soft border bg-white"},
      React.createElement("table",{className:"min-w-[1200px] w-full table-sticky"},
        React.createElement("thead",null,
          React.createElement("tr",null,
            React.createElement("th",{className:"text-left px-3 py-2 w-28"},"Status"),
            React.createElement("th",{className:"text-left px-3 py-2 w-44"},"Acoes"),
            columns.map(col=>React.createElement("th",{key:col.id,className:"text-left px-3 py-2 cursor-pointer",onClick:()=>setSort(col.id)}, col.label||col.id))
          )
        ),
        React.createElement("tbody",null,
          items.map((r,idx)=>{
            const s = (r.status||"").toUpperCase();
            const auto = (r.score ?? 0) >= 70;
            const cls = s==="OK"?"row-ok":(s==="ALERTA"?"row-alerta":(s==="DIVERGENCIA"?"row-div":"row-neutro"));
            const rowKey = (resolveRowId && resolveRowId(r)) ?? idx;
            const isSelected = selectedRowId && rowKey === selectedRowId;
            return React.createElement("tr",{key:rowKey,className:cls + (isSelected?" ring-2 ring-indigo-400":"") + " hover:bg-slate-100",style: auto?{outline:"2px solid #2563eb",outlineOffset:"-2px"}:{} ,onClick:()=>onInspect && onInspect(r)},
              React.createElement("td",{className:"px-3 py-2 align-top"}, React.createElement(Badge,{status:s})),
              React.createElement("td",{className:"px-3 py-2 align-top"},
                React.createElement("div",{className:"flex flex-col gap-1"},
                  React.createElement("button",{className:"px-2 py-1 rounded bg-emerald-100 text-emerald-800 text-xs",onClick:(e)=>{e.stopPropagation(); onManualStatus && onManualStatus(r,"OK")}},"Marcar OK"),
                  React.createElement("button",{className:"px-2 py-1 rounded bg-rose-100 text-rose-800 text-xs",onClick:(e)=>{e.stopPropagation(); onManualStatus && onManualStatus(r,"DIVERGENCIA")}},"Marcar Divergencia"),
                  React.createElement("button",{className:"px-2 py-1 rounded bg-slate-200 text-slate-700 text-xs",disabled:!r._manual,onClick:(e)=>{e.stopPropagation(); onResetStatus && onResetStatus(r)}},"Reverter")
                )
              ),
              columns.map(col=>{
                const val = r[col.id];
                const isMoney = (col.type==="money");
                const isNum = (col.type==="number");
                const txt = (val==null)?"":(isMoney?formatBRL(val):(isNum?String(val):String(val)));
                return React.createElement("td",{key:col.id,className:"px-3 py-2 align-top "+(isMoney||isNum?"cell-mono":"")},
                  txt
                );
              })
            );
          })
        )
      )
    )
  );
}

function Paginator({offset,setOffset,limit,setLimit,total,go}){
  const canPrev = offset>0;
  const canNext = offset+limit < total;
  const page = Math.floor(offset/limit)+1;
  const pages = Math.max(1, Math.ceil(total/limit));
  return (
    React.createElement("div",{className:"flex items-center justify-between mt-3"},
      React.createElement("div",null, `Mostrando ${Math.min(total, offset+1)}-${Math.min(total, offset+limit)} de ${total}`),
      React.createElement("div",{className:"flex items-center gap-2"},
        React.createElement("button",{disabled:!canPrev,onClick:()=>{setOffset(Math.max(0, offset-limit)); go();},className:"px-3 py-1 rounded bg-slate-200 disabled:opacity-50"},"<"),
        React.createElement("span",null, `Pagina ${page}/${pages}`),
        React.createElement("button",{disabled:!canNext,onClick:()=>{setOffset(offset+limit); go();},className:"px-3 py-1 rounded bg-slate-200 disabled:opacity-50"},">"),
        React.createElement("select",{className:"px-2 py-1 rounded bg-white border",value:limit,onChange:e=>{setLimit(parseInt(e.target.value,10)); setOffset(0); go();}},
          [50,100,200,500,1000].map(n=>React.createElement("option",{key:n,value:n}, n))
        )
      )
    )
  );
}

function formatBRL(x){
  const n = Number(x);
  if(Number.isNaN(n)) return x==null?"":String(x);
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function App(){
  const api = useApi(); // ajuste `window.UI_API_BASE` ou use ?api= para apontar para outro host/porta
  const [schema,setSchema] = useState(null);
  const [meta,setMeta] = useState(null);
  const [items,setItems] = useState([]);
  const [total,setTotal] = useState(0);
  const [loading,setLoading] = useState(false);
  const [error,setError] = useState(null);
  const [filters,setFilters] = useState({status:"",fonte_tipo:"",cfop:"",q:""});
  const [sortBy,setSortBy] = useState("score");
  const [sortDir,setSortDir] = useState("desc");
  const [limit,setLimit] = useState(100);
  const [offset,setOffset] = useState(0);
  const [selectedRow,setSelectedRow] = useState(null);

  const resolveRowId = useCallback((entry)=> entry?.id ?? [entry?.sucessor_idx, entry?.fonte_tipo, entry?.fonte_idx].filter(Boolean).join('-'), []);

  const handleInspect = useCallback((row)=>{
    if(!row){
      setSelectedRow(null);
      return;
    }
    setSelectedRow(row);
  },[]);

  useEffect(()=>{
    if(!selectedRow){
      return;
    }
    const rowKey = resolveRowId(selectedRow);
    const latest = items.find(item=> resolveRowId(item) === rowKey);
    if(!latest){
      setSelectedRow(null);
    }else if(latest !== selectedRow){
      setSelectedRow(latest);
    }
  },[items, resolveRowId, selectedRow]);

  const selectedRowId = selectedRow ? resolveRowId(selectedRow) : null;

  const columns = useMemo(()=> (schema?.columns || [
    {id:"strategy",label:"Regra",type:"text"},
    {id:"score",label:"Score",type:"number"},
    {id:"S.data",label:"Data (S)",type:"date"},
    {id:"S.debito",label:"Debito",type:"text"},
    {id:"S.credito",label:"Credito",type:"text"},
    {id:"S.doc",label:"No Docto (S)",type:"text"},
    {id:"S.valor",label:"Valor (S)",type:"money"},
    {id:"F.doc",label:"No Docto (F)",type:"text"},
    {id:"F.valor",label:"Valor (F)",type:"money"},
    {id:"F.cfop",label:"CFOP",type:"text"},
    {id:"delta.valor",label:"Delta Valor",type:"money"},
    {id:"delta.dias",label:"Delta Dias",type:"number"},
    {id:"motivos",label:"Motivos",type:"text"}
  ]), [schema]);

  const loadMeta = useCallback(async ()=>{
    try{
      const s = await api.get("/api/schema");
      setSchema(s);
      const m = await api.get("/api/meta");
      setMeta(m);
    }catch(e){ console.error(e); }
  },[api]);

  const loadGrid = useCallback(async ()=>{
    setLoading(true); setError(null);
    try{
      const params = {
        limit, offset,
        status: filters.status || undefined,
        fonte_tipo: filters.fonte_tipo || undefined,
        cfop: filters.cfop || undefined,
        q: filters.q || undefined,
        sort_by: sortBy || undefined,
        sort_dir: sortDir || undefined
      };
      const res = await api.get("/api/grid", params);
      setItems(res.items || []);
      setTotal(res.total_filtered || 0);
    }catch(e){ setError(String(e)); setItems([]); setTotal(0); }
    finally{ setLoading(false); }
  },[api, filters.status, filters.fonte_tipo, filters.cfop, filters.q, sortBy, sortDir, limit, offset]);

  useEffect(()=>{ loadMeta(); },[loadMeta]);
  useEffect(()=>{ loadGrid(); },[loadGrid]);

  const exportX = async ()=>{
    try{
      const out = "relatorio_conferencia.xlsx";
      const res = await api.post("/api/export/xlsx",{grid:"reconc_grid.csv",sem_fonte:"reconc_sem_fonte.csv",sem_sucessor:"reconc_sem_sucessor.csv",out});
      if(res.download){ window.open(res.download,"_blank"); }
    }catch(e){ alert("Falha no export XLSX: "+e); }
  };
  const exportP = async ()=>{
    try{
      const out = "relatorio_conferencia.pdf";
      const res = await api.post("/api/export/pdf",{grid:"reconc_grid.csv",out,cliente:"Cliente",periodo:"Periodo"});
      const link = res.download || res.download_html;
      if(link){ window.open(link,"_blank"); }
    }catch(e){ alert("Falha no export PDF: "+e); }
  };

  const updateStats = (prevStatus, nextStatus)=>{
    if(!prevStatus || !nextStatus || prevStatus===nextStatus) return;
    setMeta(current=>{
      if(!current || !current.stats) return current;
      const stats = {...current.stats};
      const prevKey = STATUS_KEY[prevStatus];
      const nextKey = STATUS_KEY[nextStatus];
      if(prevKey && stats[prevKey]!=null){ stats[prevKey] = Math.max(0, stats[prevKey]-1); }
      if(nextKey){ stats[nextKey] = (stats[nextKey]||0)+1; }
      return {...current, stats};
    });
  };

  const handleManualStatus = (row, nextStatus)=>{
    if(!row) return;
    const targetStatus = (nextStatus || "").toUpperCase();
    const rowKey = resolveRowId(row);
    let previousStatus = null;
    let updatedRow = null;
    setItems(prev=>prev.map(item=>{
      const key = resolveRowId(item);
      if(key !== rowKey) return item;
      previousStatus = (item.status || "").toUpperCase();
      const original = item.original_status || previousStatus;
      const motivos = new Set((item.motivos || "").split(";").filter(Boolean));
      motivos.add("ajuste_manual");
      const updated = {
        ...item,
        status: targetStatus,
        "match.status": targetStatus,
        motivos: Array.from(motivos).join(";"),
        _manual: true,
        original_status: original
      };
      updatedRow = updated;
      return updated;
    }));
    if(updatedRow){ setSelectedRow(updatedRow); }
    if(previousStatus){ updateStats(previousStatus, targetStatus); }
  };

  const handleResetStatus = (row)=>{
    if(!row) return;
    const rowKey = resolveRowId(row);
    let previousStatus = null;
    let originalStatus = null;
    let updatedRow = null;
    setItems(prev=>prev.map(item=>{
      const key = resolveRowId(item);
      if(key !== rowKey) return item;
      previousStatus = (item.status || "").toUpperCase();
      originalStatus = (item.original_status || item["match.status"] || item.status || "").toUpperCase();
      const motivos = (item.motivos || "").split(";").filter(Boolean).filter(tag=>tag !== "ajuste_manual");
      const updated = {
        ...item,
        status: originalStatus,
        "match.status": originalStatus,
        motivos: motivos.join(";"),
        _manual: false
      };
      updatedRow = updated;
      return updated;
    }));
    if(updatedRow){ setSelectedRow(updatedRow); }
    if(previousStatus && originalStatus){ updateStats(previousStatus, originalStatus); }
  };

  const toolbarStats = useMemo(()=>{
    const stats = meta?.stats;
    if(!stats){
      return null;
    }
    const uppercase = Object.entries(STATUS_KEY).reduce((acc,[upper,lower])=>{
      const value = stats[lower];
      acc[upper] = typeof value === "number" ? value : Number(value) || 0;
      return acc;
    },{});
    const total = Object.values(uppercase).reduce((sum,val)=> sum + (typeof val === "number" ? val : Number(val) || 0), 0);
    return {...stats, ...uppercase, TOTAL: total};
  },[meta]);

  return (

    React.createElement("div",{className:"max-w-[1400px] mx-auto p-4 md:p-6"},
      React.createElement("div",{className:"mb-4"},
        React.createElement("h2",{className:"text-2xl font-semibold"},"App de Conferencia - UI"),
        React.createElement("p",{className:"text-slate-600"},"Carrega ", React.createElement("code",null,"ui_grid.jsonl"), " do servidor local e exibe a grade com filtros e exports.")
      ),
      React.createElement(Toolbar,{
        stats: toolbarStats,
        filters,setFilters,
        onReload:()=>{ setOffset(0); loadGrid(); },
        onExportX: exportX,
        onExportP: exportP,
        loading
      }),
      error && React.createElement("div",{className:"p-3 rounded bg-rose-100 text-rose-800 mb-3"}, String(error)),
      React.createElement(Table,{
        columns,items,resolveRowId,selectedRowId,sortBy,setSortBy,sortDir,setSortDir,onInspect: handleInspect,onManualStatus: handleManualStatus,onResetStatus: handleResetStatus
      }),
      React.createElement(InspectorPanel,{
        row: selectedRow,
        onClose: ()=>setSelectedRow(null),
        onMark: handleManualStatus,
        onReset: handleResetStatus
      }),
      React.createElement(Paginator,{offset,setOffset,limit,setLimit,total,go:loadGrid})
    )
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(App));
</script>
</body>
</html>
