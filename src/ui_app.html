<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>App de Conferência — UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <style>
    .badge{border-radius:9999px;padding:.125rem .5rem;font-size:.75rem;font-weight:600;display:inline-block}
    .cell-mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .row-ok{background:#d1fae5}
    .row-alerta{background:#fef3c7}
    .row-div{background:#fee2e2}
    .row-neutro{background:#e5e7eb}
    .outline-auto{outline:2px solid #2563eb}
    .shadow-soft{box-shadow:0 1px 2px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.04)}
    .table-sticky thead th{position:sticky;top:0;background:#0f172a;color:#fff;z-index:1}
    .table-sticky thead th{font-weight:600}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div id="root"></div>

<script type="text/javascript">
const {useState,useEffect,useMemo,useCallback,Fragment} = React;

const STATUS_COLORS = {
  "OK": {bg:"#d1fae5", badge:"#16a34a", text:"#052e16"},
  "ALERTA": {bg:"#fef3c7", badge:"#f59e0b", text:"#451a03"},
  "DIVERGENCIA": {bg:"#fee2e2", badge:"#dc2626", text:"#450a0a"},
  "SEM_FONTE": {bg:"#e5e7eb", badge:"#6b7280", text:"#111827"},
  "SEM_SUCESSOR": {bg:"#e5e7eb", badge:"#6b7280", text:"#111827"},
};

function Badge({status}){
  const m = STATUS_COLORS[status] || STATUS_COLORS["SEM_FONTE"];
  return React.createElement("span",{className:"badge",style:{background:m.badge,color:m.text}},status||"—");
}

function useApi(base=""){
  const get = async (path, params={})=>{
    const qs = new URLSearchParams(params).toString();
    const url = base+path+(qs?("?"+qs):"");
    const r = await fetch(url);
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  };
  const post = async (path, body)=>{
    const r = await fetch(base+path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})});
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  };
  return {get,post};
}

function Toolbar({stats,filters,setFilters,onReload,onExportX,onExportP,loading}){
  return (
    React.createElement("div",{className:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between mb-4"},
      React.createElement("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3"},
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Total"),
          React.createElement("div",{className:"text-xl font-bold"}, stats?.TOTAL ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"OK"),
          React.createElement("div",{className:"text-xl font-bold text-emerald-700"}, stats?.OK ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Alertas"),
          React.createElement("div",{className:"text-xl font-bold text-amber-700"}, stats?.ALERTA ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Divergências"),
          React.createElement("div",{className:"text-xl font-bold text-rose-700"}, stats?.DIVERGENCIA ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Sem Fonte"),
          React.createElement("div",{className:"text-xl font-bold text-slate-700"}, stats?.SEM_FONTE ?? "—")
        ),
        React.createElement("div",{className:"p-3 rounded-xl bg-white shadow-soft"},
          React.createElement("div",{className:"text-xs text-slate-500"},"Sem Sucessor"),
          React.createElement("div",{className:"text-xl font-bold text-slate-700"}, stats?.SEM_SUCESSOR ?? "—")
        ),
      ),
      React.createElement("div",{className:"flex flex-col gap-2 md:w-[520px]"},
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("select",{className:"px-2 py-2 rounded-lg bg-white border w-40",value:filters.status,onChange:e=>setFilters(f=>({...f,status:e.target.value}))},
            React.createElement("option",{value:""},"Status — todos"),
            ["OK","ALERTA","DIVERGENCIA","SEM_FONTE","SEM_SUCESSOR"].map(s=>React.createElement("option",{key:s,value:s},s))
          ),
          React.createElement("select",{className:"px-2 py-2 rounded-lg bg-white border w-40",value:filters.fonte_tipo,onChange:e=>setFilters(f=>({...f,fonte_tipo:e.target.value}))},
            React.createElement("option",{value:""},"Fonte — todas"),
            ["ENTRADA","SAIDA","SERVICO"].map(s=>React.createElement("option",{key:s,value:s},s))
          ),
          React.createElement("input",{className:"px-3 py-2 rounded-lg bg-white border flex-1",placeholder:"CFOP",value:filters.cfop,onChange:e=>setFilters(f=>({...f,cfop:e.target.value}))})
        ),
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("input",{className:"px-3 py-2 rounded-lg bg-white border flex-1",placeholder:"Buscar (histórico, doc, tags)...",value:filters.q,onChange:e=>setFilters(f=>({...f,q:e.target.value}))}),
          React.createElement("button",{onClick:onReload,disabled:loading,className:"px-3 py-2 rounded-lg bg-slate-900 text-white disabled:opacity-50"}, loading?"Carregando...":"Atualizar")
        ),
        React.createElement("div",{className:"flex gap-2"},
          React.createElement("button",{onClick:onExportX,className:"px-3 py-2 rounded-lg bg-emerald-600 text-white"}, "Exportar Excel"),
          React.createElement("button",{onClick:onExportP,className:"px-3 py-2 rounded-lg bg-indigo-600 text-white"}, "Exportar PDF"),
          React.createElement("a",{href:"/files/",target:"_blank",className:"px-3 py-2 rounded-lg bg-slate-200"}, "Arquivos")
        )
      )
    )
  );
}

function Table({columns,items,sortBy,setSortBy,sortDir,setSortDir,onInspect}){
  const setSort = (id)=>{
    if(sortBy===id){ setSortDir(sortDir==="asc"?"desc":"asc"); } else { setSortBy(id); setSortDir("desc"); }
  };
  return (
    React.createElement("div",{className:"overflow-auto rounded-xl shadow-soft border bg-white"},
      React.createElement("table",{className:"min-w-[1200px] w-full table-sticky"},
        React.createElement("thead",null,
          React.createElement("tr",null,
            React.createElement("th",{className:"text-left px-3 py-2 w-28"},"Status"),
            columns.map(col=>React.createElement("th",{key:col.id,className:"text-left px-3 py-2 cursor-pointer",onClick:()=>setSort(col.id)}, col.label||col.id))
          )
        ),
        React.createElement("tbody",null,
          items.map((r,idx)=>{
            const s = (r.status||"").toUpperCase();
            const auto = (r.score ?? 0) >= 70;
            const cls = s==="OK"?"row-ok":(s==="ALERTA"?"row-alerta":(s==="DIVERGENCIA"?"row-div":""));
            return React.createElement("tr",{key:r.id||idx,className:cls + " hover:bg-slate-100",style: auto?{outline:"2px solid #2563eb",outlineOffset:"-2px"}:{} },
              React.createElement("td",{className:"px-3 py-2 align-top"}, React.createElement(Badge,{status:s})),
              columns.map(col=>{
                const val = r[col.id];
                const isMoney = (col.type==="money");
                const isNum = (col.type==="number");
                const txt = (val==null)?"":(isMoney?formatBRL(val):(isNum?String(val):String(val)));
                return React.createElement("td",{key:col.id,className:"px-3 py-2 align-top "+(isMoney||isNum?"cell-mono":"")},
                  txt
                );
              })
            );
          })
        )
      )
    )
  );
}

function Paginator({offset,setOffset,limit,setLimit,total,go}){
  const canPrev = offset>0;
  const canNext = offset+limit < total;
  const page = Math.floor(offset/limit)+1;
  const pages = Math.max(1, Math.ceil(total/limit));
  return (
    React.createElement("div",{className:"flex items-center justify-between mt-3"},
      React.createElement("div",null, `Mostrando ${Math.min(total, offset+1)}–${Math.min(total, offset+limit)} de ${total}`),
      React.createElement("div",{className:"flex items-center gap-2"},
        React.createElement("button",{disabled:!canPrev,onClick:()=>{setOffset(Math.max(0, offset-limit)); go();},className:"px-3 py-1 rounded bg-slate-200 disabled:opacity-50"},"◀"),
        React.createElement("span",null, `Página ${page}/${pages}`),
        React.createElement("button",{disabled:!canNext,onClick:()=>{setOffset(offset+limit); go();},className:"px-3 py-1 rounded bg-slate-200 disabled:opacity-50"},"▶"),
        React.createElement("select",{className:"px-2 py-1 rounded bg-white border",value:limit,onChange:e=>{setLimit(parseInt(e.target.value,10)); setOffset(0); go();}},
          [50,100,200,500,1000].map(n=>React.createElement("option",{key:n,value:n}, n))
        )
      )
    )
  );
}

function formatBRL(x){
  const n = Number(x);
  if(Number.isNaN(n)) return x==null?"":String(x);
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function App(){
  const api = useApi(""); // ajuste aqui se o backend não estiver no mesmo host/porta
  const [schema,setSchema] = useState(null);
  const [meta,setMeta] = useState(null);
  const [items,setItems] = useState([]);
  const [total,setTotal] = useState(0);
  const [loading,setLoading] = useState(false);
  const [error,setError] = useState(null);
  const [filters,setFilters] = useState({status:"",fonte_tipo:"",cfop:"",q:""});
  const [sortBy,setSortBy] = useState("score");
  const [sortDir,setSortDir] = useState("desc");
  const [limit,setLimit] = useState(100);
  const [offset,setOffset] = useState(0);

  const columns = useMemo(()=> (schema?.columns || [
    {id:"strategy",label:"Regra",type:"text"},
    {id:"score",label:"Score",type:"number"},
    {id:"S.data",label:"Data (S)",type:"date"},
    {id:"S.debito",label:"Débito",type:"text"},
    {id:"S.credito",label:"Crédito",type:"text"},
    {id:"S.doc",label:"Nº Docto (S)",type:"text"},
    {id:"S.valor",label:"Valor (S)",type:"money"},
    {id:"F.doc",label:"Nº Docto (F)",type:"text"},
    {id:"F.valor",label:"Valor (F)",type:"money"},
    {id:"F.cfop",label:"CFOP",type:"text"},
    {id:"delta.valor",label:"Δ Valor",type:"money"},
    {id:"delta.dias",label:"Δ Dias",type:"number"},
    {id:"motivos",label:"Motivos",type:"text"}
  ]), [schema]);

  const loadMeta = useCallback(async ()=>{
    try{
      const s = await api.get("/api/schema");
      setSchema(s);
      const m = await api.get("/api/meta");
      setMeta(m);
    }catch(e){ console.error(e); }
  },[]);

  const loadGrid = useCallback(async ()=>{
    setLoading(true); setError(null);
    try{
      const params = {
        limit, offset,
        status: filters.status || undefined,
        fonte_tipo: filters.fonte_tipo || undefined,
        cfop: filters.cfop || undefined,
        q: filters.q || undefined,
        sort_by: sortBy || undefined,
        sort_dir: sortDir || undefined
      };
      const res = await api.get("/api/grid", params);
      setItems(res.items || []);
      setTotal(res.total_filtered || 0);
    }catch(e){ setError(String(e)); setItems([]); setTotal(0); }
    finally{ setLoading(false); }
  },[filters,status,sortBy,sortDir,limit,offset]);

  useEffect(()=>{ loadMeta(); },[]);
  useEffect(()=>{ loadGrid(); },[sortBy,sortDir,limit,offset,filters.status,filters.fonte_tipo,filters.cfop]);

  const exportX = async ()=>{
    try{
      const out = "relatorio_conferencia.xlsx";
      const res = await api.post("/api/export/xlsx",{grid:"reconc_grid.csv",sem_fonte:"reconc_sem_fonte.csv",sem_sucessor:"reconc_sem_sucessor.csv",out});
      if(res.download){ window.open(res.download,"_blank"); }
    }catch(e){ alert("Falha no export XLSX: "+e); }
  };
  const exportP = async ()=>{
    try{
      const out = "relatorio_conferencia.pdf";
      const res = await api.post("/api/export/pdf",{grid:"reconc_grid.csv",out,cliente:"Cliente",periodo:"Período"});
      const link = res.download || res.download_html;
      if(link){ window.open(link,"_blank"); }
    }catch(e){ alert("Falha no export PDF: "+e); }
  };

  return (
    React.createElement("div",{className:"max-w-[1400px] mx-auto p-4 md:p-6"},
      React.createElement("div",{className:"mb-4"},
        React.createElement("h2",{className:"text-2xl font-semibold"},"App de Conferência — UI"),
        React.createElement("p",{className:"text-slate-600"},"Carrega ", React.createElement("code",null,"ui_grid.jsonl"), " do servidor local e exibe a grade com filtros e exports.")
      ),
      React.createElement(Toolbar,{
        stats: (meta && meta.stats) ? {...meta.stats, TOTAL:(meta.stats.ok||0)+(meta.stats.alerta||0)+(meta.stats.divergencia||0)+(meta.stats.sem_fonte||0)+(meta.stats.sem_sucessor||0)} : null,
        filters,setFilters,
        onReload:()=>{ setOffset(0); loadGrid(); },
        onExportX: exportX,
        onExportP: exportP,
        loading
      }),
      error && React.createElement("div",{className:"p-3 rounded bg-rose-100 text-rose-800 mb-3"}, String(error)),
      React.createElement(Table,{
        columns,items,sortBy,setSortBy,sortDir,setSortDir,onInspect:()=>{}
      }),
      React.createElement(Paginator,{offset,setOffset,limit,setLimit,total,go:loadGrid})
    )
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(App));
</script>
</body>
</html>
